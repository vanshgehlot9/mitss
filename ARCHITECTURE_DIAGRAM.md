# ğŸ—ï¸ Razorpay Integration Architecture

## System Architecture Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         CLIENT / BROWSER                             â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Product Page   â”‚  â”‚   Cart Page      â”‚  â”‚  Checkout Page   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â”‚                   â”‚                      â”‚              â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                               â–¼                                     â”‚
â”‚                  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚                  â”‚  Razorpay Components   â”‚                        â”‚
â”‚                  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                        â”‚
â”‚                  â”‚ RazorpayCheckout       â”‚                        â”‚
â”‚                  â”‚ RazorpayPaymentButton  â”‚                        â”‚
â”‚                  â”‚ RazorpayOrderStatus    â”‚                        â”‚
â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                           â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â”‚ HTTPS
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      NEXT.JS SERVER (Backend)                        â”‚
â”‚                                                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                   API Routes Layer                            â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â”‚  /api/razorpay/                                              â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ create-order/route.ts    (POST/GET)                    â”‚  â”‚
â”‚  â”‚  â”œâ”€â”€ verify-payment/route.ts  (POST/GET)                    â”‚  â”‚
â”‚  â”‚  â””â”€â”€ webhook/route.ts         (POST)                        â”‚  â”‚
â”‚  â”‚                                                               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                              â”‚                      â”‚
â”‚               â–¼                              â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚  Razorpay Utils     â”‚        â”‚  Database Layer      â”‚          â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤          â”‚
â”‚  â”‚ â€¢ Create Order      â”‚        â”‚ â€¢ MongoDB Client     â”‚          â”‚
â”‚  â”‚ â€¢ Verify Signature  â”‚        â”‚ â€¢ getDatabase()      â”‚          â”‚
â”‚  â”‚ â€¢ Fetch Payment     â”‚        â”‚ â€¢ Collections:       â”‚          â”‚
â”‚  â”‚ â€¢ Webhook Verify    â”‚        â”‚   - orders           â”‚          â”‚
â”‚  â”‚ â€¢ Error Handling    â”‚        â”‚   - payments         â”‚          â”‚
â”‚  â”‚ â€¢ Amount Convert    â”‚        â”‚   - webhooks         â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚            â”‚                               â”‚                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                               â”‚
             â”‚ API Calls                     â”‚ Read/Write
             â–¼                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   RAZORPAY API       â”‚        â”‚   MONGODB DATABASE   â”‚
â”‚                      â”‚        â”‚                      â”‚
â”‚ â€¢ Create Order       â”‚        â”‚ razorpay_orders      â”‚
â”‚ â€¢ Fetch Payment      â”‚        â”‚ razorpay_payments    â”‚
â”‚ â€¢ Fetch Order        â”‚        â”‚ razorpay_webhooks    â”‚
â”‚ â€¢ Process Refund     â”‚        â”‚                      â”‚
â”‚ â€¢ Send Webhooks      â”‚        â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Payment Flow Sequence

```
User                Frontend            Backend API         Razorpay API      MongoDB
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚  Click "Pay Now"    â”‚                    â”‚                    â”‚              â”‚
 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚  POST /create-orderâ”‚                    â”‚              â”‚
 â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚  Create Order      â”‚              â”‚
 â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
 â”‚                     â”‚                    â”‚  (razorpay_order)  â”‚              â”‚
 â”‚                     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚  Save Order        â”‚              â”‚
 â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚              â”‚
 â”‚                     â”‚  {orderId, key}    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚  Razorpay Modal     â”‚                    â”‚                    â”‚              â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚              â”‚
 â”‚  (Checkout UI)      â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚  Enter Card Details â”‚                    â”‚                    â”‚              â”‚
 â”‚  & Submit           â”‚                    â”‚                    â”‚              â”‚
 â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚    Process Payment â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚  Payment Response   â”‚                    â”‚                    â”‚              â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
 â”‚  {payment_id,       â”‚                    â”‚                    â”‚              â”‚
 â”‚   signature}        â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚  POST /verify-payment                   â”‚              â”‚
 â”‚                     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                    â”‚              â”‚
 â”‚                     â”‚  {payment_id,      â”‚                    â”‚              â”‚
 â”‚                     â”‚   signature}       â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚  Verify Signature  â”‚              â”‚
 â”‚                     â”‚                    â”‚  (HMAC SHA256)     â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚  Fetch Payment     â”‚              â”‚
 â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚              â”‚
 â”‚                     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚  Update Order      â”‚              â”‚
 â”‚                     â”‚                    â”‚  Save Payment      â”‚              â”‚
 â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚              â”‚
 â”‚                     â”‚  {success: true}   â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚  Success Message    â”‚                    â”‚                    â”‚              â”‚
 â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                    â”‚                    â”‚              â”‚
 â”‚  Redirect to        â”‚                    â”‚                    â”‚              â”‚
 â”‚  Order Confirmation â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚  Async Webhook     â”‚              â”‚
 â”‚                     â”‚                    â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
 â”‚                     â”‚                    â”‚  payment.captured  â”‚              â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
 â”‚                     â”‚                    â”‚  Update Status     â”‚              â”‚
 â”‚                     â”‚                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
 â”‚                     â”‚                    â”‚                    â”‚              â”‚
```

## Component Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Frontend Components                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  RazorpayCheckout (Full Form)                              â”‚
â”‚  â”œâ”€â”€ Customer Form (name, email, phone)                    â”‚
â”‚  â”œâ”€â”€ Address Form (shipping address)                       â”‚
â”‚  â”œâ”€â”€ Order Summary                                         â”‚
â”‚  â”œâ”€â”€ Validation Logic                                      â”‚
â”‚  â”œâ”€â”€ Razorpay Script Loader                               â”‚
â”‚  â””â”€â”€ Payment Handler                                       â”‚
â”‚      â”œâ”€â”€ Create Order API Call                            â”‚
â”‚      â”œâ”€â”€ Open Razorpay Modal                              â”‚
â”‚      â”œâ”€â”€ Handle Success â†’ Verify Payment                  â”‚
â”‚      â””â”€â”€ Handle Failure â†’ Show Error                      â”‚
â”‚                                                              â”‚
â”‚  RazorpayPaymentButton (Simple)                            â”‚
â”‚  â”œâ”€â”€ Button UI                                             â”‚
â”‚  â”œâ”€â”€ Loading State                                         â”‚
â”‚  â””â”€â”€ Payment Handler (same flow)                          â”‚
â”‚                                                              â”‚
â”‚  RazorpayOrderStatus (Confirmation)                        â”‚
â”‚  â”œâ”€â”€ Fetch Order Details                                   â”‚
â”‚  â”œâ”€â”€ Fetch Payment Details                                 â”‚
â”‚  â”œâ”€â”€ Display Order Summary                                 â”‚
â”‚  â”œâ”€â”€ Display Payment Info                                  â”‚
â”‚  â”œâ”€â”€ Display Status Badges                                 â”‚
â”‚  â””â”€â”€ Action Buttons                                        â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## API Routes Structure

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Route: create-order                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  POST Handler                                                â”‚
â”‚  â”œâ”€â”€ Validate Input                                         â”‚
â”‚  â”‚   â”œâ”€â”€ Amount                                            â”‚
â”‚  â”‚   â”œâ”€â”€ Customer Data                                     â”‚
â”‚  â”‚   â”œâ”€â”€ Items                                             â”‚
â”‚  â”‚   â””â”€â”€ Address                                           â”‚
â”‚  â”œâ”€â”€ Create Razorpay Order                                 â”‚
â”‚  â”‚   â”œâ”€â”€ Call Razorpay API                                â”‚
â”‚  â”‚   â””â”€â”€ Get razorpay_order_id                            â”‚
â”‚  â”œâ”€â”€ Format Order Data                                     â”‚
â”‚  â”œâ”€â”€ Save to MongoDB                                       â”‚
â”‚  â”‚   â””â”€â”€ razorpay_orders collection                       â”‚
â”‚  â””â”€â”€ Return Response                                       â”‚
â”‚      â”œâ”€â”€ orderId                                           â”‚
â”‚      â”œâ”€â”€ razorpayOrderId                                   â”‚
â”‚      â”œâ”€â”€ amount                                            â”‚
â”‚      â””â”€â”€ keyId (public)                                    â”‚
â”‚                                                              â”‚
â”‚  GET Handler                                                 â”‚
â”‚  â”œâ”€â”€ Get orderId from query                                â”‚
â”‚  â”œâ”€â”€ Fetch from MongoDB                                    â”‚
â”‚  â””â”€â”€ Return Order                                          â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                  API Route: verify-payment                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  POST Handler                                                â”‚
â”‚  â”œâ”€â”€ Get Payment Data                                       â”‚
â”‚  â”‚   â”œâ”€â”€ razorpay_order_id                                â”‚
â”‚  â”‚   â”œâ”€â”€ razorpay_payment_id                              â”‚
â”‚  â”‚   â””â”€â”€ razorpay_signature                               â”‚
â”‚  â”œâ”€â”€ Verify Signature (CRITICAL)                           â”‚
â”‚  â”‚   â”œâ”€â”€ Generate Expected Signature                      â”‚
â”‚  â”‚   â”‚   â””â”€â”€ HMAC SHA256                                  â”‚
â”‚  â”‚   â””â”€â”€ Compare Signatures                               â”‚
â”‚  â”œâ”€â”€ Fetch Payment from Razorpay                           â”‚
â”‚  â”œâ”€â”€ Validate Amount                                       â”‚
â”‚  â”œâ”€â”€ Update MongoDB                                        â”‚
â”‚  â”‚   â”œâ”€â”€ Update Order Status                              â”‚
â”‚  â”‚   â””â”€â”€ Save Payment Record                              â”‚
â”‚  â””â”€â”€ Return Verification Result                            â”‚
â”‚                                                              â”‚
â”‚  GET Handler                                                 â”‚
â”‚  â”œâ”€â”€ Get paymentId or orderId                              â”‚
â”‚  â”œâ”€â”€ Fetch from MongoDB                                    â”‚
â”‚  â””â”€â”€ Return Payment Details                                â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    API Route: webhook                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  POST Handler (Called by Razorpay)                          â”‚
â”‚  â”œâ”€â”€ Get Webhook Signature from Header                     â”‚
â”‚  â”œâ”€â”€ Get Raw Body                                           â”‚
â”‚  â”œâ”€â”€ Verify Webhook Signature                              â”‚
â”‚  â”œâ”€â”€ Log Event to Database                                 â”‚
â”‚  â”‚   â””â”€â”€ razorpay_webhooks collection                     â”‚
â”‚  â”œâ”€â”€ Process Event Type                                    â”‚
â”‚  â”‚   â”œâ”€â”€ payment.captured                                 â”‚
â”‚  â”‚   â”‚   â”œâ”€â”€ Update Payment Status                        â”‚
â”‚  â”‚   â”‚   â””â”€â”€ Update Order Status â†’ PAID                   â”‚
â”‚  â”‚   â”œâ”€â”€ payment.failed                                   â”‚
â”‚  â”‚   â”‚   â””â”€â”€ Update Order Status â†’ FAILED                 â”‚
â”‚  â”‚   â”œâ”€â”€ payment.authorized                               â”‚
â”‚  â”‚   â”œâ”€â”€ order.paid                                       â”‚
â”‚  â”‚   â”œâ”€â”€ refund.created                                   â”‚
â”‚  â”‚   â””â”€â”€ refund.processed                                 â”‚
â”‚  â”œâ”€â”€ Mark Webhook as Processed                             â”‚
â”‚  â””â”€â”€ Return 200 OK                                         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Security Layer

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Security Measures                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                   â”‚
â”‚  1. Signature Verification                       â”‚
â”‚     â”œâ”€â”€ Payment Signature (HMAC SHA256)         â”‚
â”‚     â”‚   â””â”€â”€ order_id|payment_id + secret        â”‚
â”‚     â””â”€â”€ Webhook Signature (HMAC SHA256)         â”‚
â”‚         â””â”€â”€ raw_payload + webhook_secret        â”‚
â”‚                                                   â”‚
â”‚  2. Server-Side Validation                       â”‚
â”‚     â”œâ”€â”€ Amount Validation                        â”‚
â”‚     â”œâ”€â”€ Email Format                             â”‚
â”‚     â”œâ”€â”€ Phone Number Format                      â”‚
â”‚     â””â”€â”€ Order Integrity                          â”‚
â”‚                                                   â”‚
â”‚  3. Environment Protection                       â”‚
â”‚     â”œâ”€â”€ API Keys in .env                         â”‚
â”‚     â”œâ”€â”€ Never exposed to client                  â”‚
â”‚     â””â”€â”€ Public key separate                      â”‚
â”‚                                                   â”‚
â”‚  4. Database Security                            â”‚
â”‚     â”œâ”€â”€ All transactions logged                  â”‚
â”‚     â”œâ”€â”€ Audit timestamps                         â”‚
â”‚     â””â”€â”€ Status tracking                          â”‚
â”‚                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Error Handling Flow

```
Error Occurs
    â”‚
    â”œâ”€â”€ Frontend Error
    â”‚   â”œâ”€â”€ Form Validation â†’ Show field error
    â”‚   â”œâ”€â”€ Network Error â†’ Show retry option
    â”‚   â”œâ”€â”€ Razorpay Modal Closed â†’ "Payment cancelled"
    â”‚   â””â”€â”€ Payment Failed â†’ Show error message
    â”‚
    â”œâ”€â”€ Backend Error
    â”‚   â”œâ”€â”€ Validation Error â†’ 400 + message
    â”‚   â”œâ”€â”€ Razorpay API Error â†’ Log + 500
    â”‚   â”œâ”€â”€ Database Error â†’ Log + 500
    â”‚   â””â”€â”€ Signature Verification Failed â†’ Log + 400
    â”‚
    â””â”€â”€ Webhook Error
        â”œâ”€â”€ Invalid Signature â†’ Log + 400
        â”œâ”€â”€ Processing Error â†’ Log to DB
        â””â”€â”€ Unknown Event â†’ Log + 200 (acknowledge)
```

## Database Schema

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      razorpay_orders Collection         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _id: ObjectId                           â”‚
â”‚ orderId: "ORD-xxx"                      â”‚
â”‚ razorpayOrderId: "order_xxx"           â”‚
â”‚ items: [...]                            â”‚
â”‚ totalAmount: Number                     â”‚
â”‚ customer: {...}                         â”‚
â”‚ shippingAddress: {...}                  â”‚
â”‚ status: "created" | "paid" | "failed"  â”‚
â”‚ paymentStatus: "created" | "captured"  â”‚
â”‚ signatureVerified: Boolean              â”‚
â”‚ createdAt: Date                         â”‚
â”‚ paidAt: Date                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     razorpay_payments Collection        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _id: ObjectId                           â”‚
â”‚ paymentId: "pay_xxx"                    â”‚
â”‚ orderId: "ORD-xxx"                      â”‚
â”‚ razorpayOrderId: "order_xxx"           â”‚
â”‚ amount: Number (paise)                  â”‚
â”‚ status: "captured" | "failed"          â”‚
â”‚ method: "card" | "upi" | "netbanking" â”‚
â”‚ signature: String                       â”‚
â”‚ signatureVerified: Boolean              â”‚
â”‚ razorpayResponse: {...}                 â”‚
â”‚ createdAt: Date                         â”‚
â”‚ capturedAt: Date                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     razorpay_webhooks Collection        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ _id: ObjectId                           â”‚
â”‚ eventId: "evt_xxx"                      â”‚
â”‚ event: "payment.captured"              â”‚
â”‚ entity: "payment"                       â”‚
â”‚ payload: {...}                          â”‚
â”‚ processed: Boolean                      â”‚
â”‚ signatureVerified: Boolean              â”‚
â”‚ receivedAt: Date                        â”‚
â”‚ processedAt: Date                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Quick Reference

### Environment Variables
```
RAZORPAY_KEY_ID          - Test: rzp_test_RfFWI9Ba2Hz1e1
RAZORPAY_KEY_SECRET      - Backend only (never expose)
RAZORPAY_WEBHOOK_SECRET  - For webhook verification
NEXT_PUBLIC_RAZORPAY_KEY_ID - Public key for frontend
```

### Key Functions
```
createRazorpayOrder()      - Create order via API
verifyRazorpaySignature()  - Verify payment
verifyWebhookSignature()   - Verify webhook
fetchPaymentDetails()      - Get payment info
```

### Key Routes
```
/api/razorpay/create-order   - POST/GET
/api/razorpay/verify-payment - POST/GET
/api/razorpay/webhook        - POST
```

### Components
```
<RazorpayCheckout />        - Full form
<RazorpayPaymentButton />   - Quick button
<RazorpayOrderStatus />     - Confirmation
```

---

This architecture ensures:
- âœ… Secure payment processing
- âœ… Proper error handling
- âœ… Complete audit trail
- âœ… Scalable design
- âœ… Production-ready code
